#!/usr/bin/env bash
set -euo pipefail

# Minimize a Debian or Ubuntu cloud image to a provider-agnostic baseline. Removes AWS, Azure, GCP, IBM Cloud,
# Oracle Cloud, Rackspace, DigitalOcean, Linode, Vultr, Equinix Metal, OVHcloud, Hetzner, Ionos, Scaleway,
# Yandex Cloud, UpCloud, Exoscale, Leaseweb, Selectel, Gcore, Civo, Cherry Servers, Alibaba Cloud, Huawei Cloud,
# Tencent Cloud, Baidu Cloud, and Naver Cloud specific packages, repos, configs, and services, then strips
# everything not in the whitelist.

test "${EUID}" -eq 0 || { echo "Error: must run as root" >&2; exit 1; }


# Detect distro and write clean apt sources (deb822 format)
. /etc/os-release
rm -rf /etc/apt/{sources.list,sources.list~,sources.list.d/*,mirrors,preferences.d} \
       /var/lib/apt/{lists/*,periodic/*,cdroms.list*,daily_lock}
case "${ID}" in
    debian)
        _repo_uri="http://deb.debian.org/debian"
        _security_uri="http://deb.debian.org/debian-security"
        _components="main"
        ;;
    ubuntu)
        _repo_uri="http://archive.ubuntu.com/ubuntu"
        _security_uri="http://security.ubuntu.com/ubuntu"
        _components="main restricted universe"
        ;;
esac
cat > "/etc/apt/sources.list.d/${ID}.sources" <<EOF
Types: deb
URIs: ${_repo_uri}
Suites: ${VERSION_CODENAME} ${VERSION_CODENAME}-updates
Components: ${_components}
Signed-By: /usr/share/keyrings/${ID}-archive-keyring.gpg

Types: deb
URIs: ${_security_uri}
Suites: ${VERSION_CODENAME}-security
Components: ${_components}
Signed-By: /usr/share/keyrings/${ID}-archive-keyring.gpg
EOF



# Lock root account (no password, no direct login)
passwd -l root

# Disable and remove provider-created swap
swapoff -a 2>/dev/null || true
sed -i '/swap/d' /etc/fstab

# Get rid of garbage in grub file, if any
test -f /etc/default/grub && sed -i 's/ PACKER_SSHPUBKEY=[^ ]*//' /etc/default/grub

# Set locale and timezone
echo 'LANG=en_US.UTF-8'  > /etc/locale.conf
echo 'en_US.UTF-8 UTF-8' > /etc/locale.gen
ln -sf /usr/share/zoneinfo/UTC /etc/localtime
echo "UTC" > /etc/timezone

# Reset hosts file
cat > /etc/hosts <<EOF
127.0.0.1   localhost
::1         localhost ip6-localhost ip6-loopback
EOF



# Required packages MUST be installed; allowed packages CAN be installed (preserved if already present)
_required_packages=(
    # Init, system, package management
    systemd systemd-sysv dbus udev apt dpkg dialog
    # Base system
    base-files base-passwd bash coreutils debianutils diffutils findutils
    sudo grep gzip zstd login passwd sed tar util-linux htop less nano
    # Networking & DHCP
    iproute2 netbase ca-certificates curl wget socat traceroute iputils-ping
    # SSH & cloud-init
    openssh-server openssh-client cloud-init
)
_allowed_packages=(
    # Kernel & boot (Debian)
    linux-image-amd64 linux-image-cloud-amd64 linux-image-arm64 linux-image-cloud-arm64 linux-image-686-pae linux-image-686 linux-image-armmp linux-image-armmp-lpae linux-image-powerpc64le linux-image-s390x linux-image-riscv64
    amd64-microcode intel-microcode
    grub-pc grub-efi-amd64 grub-efi-arm64 grub-efi-ia32 grub-ieee1275
    # Kernel & boot (Ubuntu)
    linux-image-virtual grub-efi-amd64-signed grub-efi-arm64-signed initramfs-tools
    # Networking & DHCP (provider-dependent)
    dhcpcd-base dhcpcd5 ifupdown netplan.io systemd-resolved
)

# Update indices and install required packages
DEBIAN_FRONTEND=noninteractive apt-get update -o Acquire::PDiffs=false -o Acquire::Languages=none
DEBIAN_FRONTEND=noninteractive apt-get install -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confnew" "${_required_packages[@]}"

# APT's VersionedKernelPackages protects linux-headers from autoremove; purge explicitly
{ dpkg -l 'linux-headers-*' 2>/dev/null || true; } | awk '/^ii/ {print $2}' | xargs -r apt-get purge -y

# Build the list of installed packages to preserve (required and allowed); nuke everything else
_preserve_packages=("${_required_packages[@]}")
for pkg in "${_allowed_packages[@]}"; do
    if dpkg-query -W -f='${Status}' "${pkg}" 2> /dev/null | grep -q "install ok installed"; then
        _preserve_packages+=("${pkg}")
    fi
done
# Mark all as auto (can be removed), then mark keepers as manual (to be preserved)
apt-mark showmanual | xargs -r apt-mark auto > /dev/null 2>&1
apt-mark manual "${_preserve_packages[@]}" > /dev/null 2>&1
DEBIAN_FRONTEND=noninteractive apt-get autoremove --purge -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confnew" -o APT::AutoRemove::RecommendsImportant=false -o APT::AutoRemove::SuggestsImportant=false

# Clear debconf database and normalize configs modified by cloud providers
dpkg-query -W -f='${Package}\n' | xargs -I{} /usr/bin/bash -c 'echo PURGE | DEBIAN_FRONTEND=noninteractive debconf-communicate {} > /dev/null'
rm -f /etc/apt/apt.conf.d/* /etc/ssh/sshd_config /etc/skel/.bashrc /var/cache/debconf/{config,templates}.dat-old /var/cache/debconf/passwords.dat
DEBIAN_FRONTEND=noninteractive apt-get install --reinstall -y -o Dpkg::Options::="--force-confmiss" -o Dpkg::Options::="--force-confnew" openssh-server libpam-runtime apt bash ca-certificates



# Remove stale Python bytecode
find /usr/lib /var -name '*.pyc' -delete
# Cleanup unused files, files that can be regenerated, or provider-specific files
rm -rf \
    `# identity       ` /etc/{hostname,adjtime,aliases,mailname,cloud-release} \
    `# user backups   ` /etc/{passwd,group,shadow,gshadow,subuid,subgid}- \
    `# crypt tab      ` /etc/crypttab \
    `# users          ` /home/*/{.ssh/authorized_keys,.bash_history} \
    `# motd/banners   ` /etc/{motd,update-motd.d/*} /run/motd.dynamic \
    `# cloud-init     ` /etc/{sudoers.d/*,ssh/sshd_config.d/*,skel/.cloud-locale-test.skip,initramfs-tools/conf.d/resume} \
    `# dpkg leftovers ` /etc/{dhcpcd.conf.dpkg-dist,default/grub.ucf-dist,.resolv.conf.systemd-resolved.bak,apparmor.d} /usr/share/dict/common.* /usr/lib/firmware/regulatory.db{,.p7s} \
    `# pam            ` /etc/pam.d/*.pam-old \
    `# timesyncd      ` /etc/systemd/{timesyncd.conf,timesyncd.conf.d} /etc/systemd/system/{,*/}{systemd-timesyncd,dbus-org.freedesktop.timesync1}.service /etc/dhcp /var/lib/systemd/{deb-systemd-helper-enabled/*timesync*,deb-systemd-helper-enabled/*time-wait*,deb-systemd-helper-enabled/*/systemd-time*,timesync} /var/lib/dpkg/info/systemd-timesyncd.* \
    `# snap           ` /snap /var/{snap,lib/snapd} \
    `# stale timers   ` /var/lib/systemd/timers/stamp-*.timer \
    `# backups        ` /var/backups/* /var/lib/ucf/{hashfile.*,registry.*} \
    `# root           ` /root/{*,.[!.]*} \
    `# logs and temp  ` /var/{log/*,tmp/*} /tmp/* \
    `# swap           ` /swapfile \
    `# Providers:     ` \
    `# AWS            ` /opt/aws /etc/amazon /var/lib/amazon /usr/share/ec2-instance-connect \
    `# Azure          ` /var/lib/waagent /etc/waagent.conf /{opt,var/opt,etc/opt}/microsoft /opt/omi \
    `# GCP            ` /etc/{default/instance_configs.cfg*,google_instance_id,boto.cfg} /usr/bin/google_* /usr/share/google-guest-agent /var/lib/google* \
    `# IBM Cloud      ` /opt/{IBM,bnpp,BUAgent,draios} \
    `# Oracle Cloud   ` /{opt,etc,usr/libexec}/oracle-cloud* /var/lib/oracle-cloud-agent \
    `# Rackspace      ` /usr/share/nova-agent /etc/rackspace-monitoring-agent \
    `# DigitalOcean   ` /opt/digitalocean /etc/do-agent /etc/systemd/system/{,*/}vpc-peering.service \
    `# Linode         ` /{opt,etc}/linode /etc/{profile.d/lish.sh,network/.interfaces.linode-*,.resolv.conf.linode-*} \
    `# Vultr          ` /{opt,etc,var/lib}/vultr /usr/lib/systemd/system/cloud-init-log-reader.service \
    `# Equinix Metal  ` /{opt,etc}/packet \
    `# OVHcloud       ` /{opt,etc}/ovh /usr/bin/{noderig,beamium} /opt/{noderig,beamium} /etc/beamium \
    `# Hetzner        ` /etc/{hc-utils,hetzner-build} \
    `# Ionos          ` /{etc,opt}/ionos \
    `# Scaleway       ` /{etc,opt}/scaleway /usr/local/sbin/scw-* \
    `# Yandex Cloud   ` /{opt,etc}/yandex \
    `# UpCloud        ` /{etc,opt}/upcloud \
    `# Exoscale       ` /{etc,opt}/exoscale \
    `# Leaseweb       ` /opt/leaseweb \
    `# Selectel       ` /opt/selectel \
    `# Gcore          ` /{etc,opt}/gcore \
    `# Civo           ` /{etc,opt}/civo \
    `# Cherry Servers ` /{etc,opt}/cherry \
    `# Alibaba Cloud  ` /usr/local/aegis /usr/sbin/aliyun* /etc/aliyun* /opt/Chinese /usr/local/{cloudmonitor,share/aliyun-assist,share/assist-daemon} \
    `# Huawei Cloud   ` /usr/local/hostguard /opt/huawei \
    `# Tencent Cloud  ` /usr/local/{qcloud,tat-agent,barad,sgagent,YDLive} /var/lib/qcloud \
    `# Baidu Cloud    ` /usr/local/bce /opt/hosteye \
    `# Naver Cloud    ` /opt/{ncloud,nbp}



# Remove users and groups now that packages (and their services) are purged
_remove_users=(Debian-exim polkitd systemd-timesync uuidd)
_remove_users+=($(awk -F: '$3 >= 1000 && $3 < 65534 {print $1}' /etc/passwd))
_remove_groups=(Debian-exim docker google-sudoers lxd polkitd systemd-timesync uuidd)
for _u in "${_remove_users[@]}";  do getent passwd "${_u}" > /dev/null 2>&1 && userdel -rf "${_u}" || true; done
for _g in "${_remove_groups[@]}"; do getent group  "${_g}" > /dev/null 2>&1 && groupdel    "${_g}" || true; done



# FUTURE: the following is typical post-install done by other scripts (for snapshotting)

# Regenerate machine-id
# systemd-machine-id-setup
# Regenerate SSH security keys

DEBIAN_FRONTEND=noninteractive apt-get update -o Acquire::PDiffs=false -o Acquire::Languages=none
DEBIAN_FRONTEND=noninteractive apt-get dist-upgrade -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confnew" -o Dpkg::Options::="--force-overwrite"
DEBIAN_FRONTEND=noninteractive apt-get autoremove --purge -y -o Dpkg::Options::="--force-confdef" -o Dpkg::Options::="--force-confnew" -o Dpkg::Options::="--force-overwrite" -o APT::AutoRemove::RecommendsImportant=false -o APT::AutoRemove::SuggestsImportant=false
apt-get clean -y

mkdir -p /root/.ssh/
cat > /root/.ssh/authorized_keys <<EOF
ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIBZoWV3jeaTVhwJhtXGkpcns8v/NNFvTOfEoUY6EzJ/D jonathan-oliver
EOF
chmod 0700 /root/.ssh && chmod 0600 /root/.ssh/authorized_keys

reboot
